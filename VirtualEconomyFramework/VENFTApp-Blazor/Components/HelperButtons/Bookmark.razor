@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject AppData AppData

<a style="font-size: 16px; margin-left:10px; margin-bottom: 5px" @onclick="showAddOrRemoveBookmark">
    @if (IsInBookmarks)
    {
        <i class="oi oi-star text-warning"></i>
    }
    else
    {
        <i class="oi oi-star text-secondary"></i>
    }
</a>

<VENFTApp_Blazor.Components.Modal.Modal @bind-Visible="@addBookmarkVisible">
    <ModalHeader>
        <ModalTitle>Add Bookmark</ModalTitle>
    </ModalHeader>
    <ModalBody>
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="col d-flex justify-content-center align-items-center">
                        <span>Please Input Name</span>
                    </div>
                </div>
                <div class="row" style="margin-top:10px;">
                    <div class="col d-flex justify-content-center align-items-center">
                        <Input Placeholder="Add Name" @bind-Value="@newBookmark.Name" Style="font-size:12px; min-width:150px; max-width:250px;" />
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex justify-content-center align-items-center">
                        <span>You can add some note</span>
                    </div>
                </div>
                <div class="row" style="margin-top:10px;">
                    <div class="col d-flex justify-content-center align-items-center">
                        <Input Placeholder="Add Note" @bind-Value="@newBookmark.Note" Style="font-size:12px; min-width:150px; max-width:250px;" />
                    </div>
                </div>
            </div>
        </div>
    </ModalBody>
    <VENFTApp_Blazor.Components.Modal.ModalFooter>
        <ModalButton Kind="ModalButtonKind.Cancel">Cancel</ModalButton>
        <ModalButton OnClick="@AddBookmarkConfirm">Ok</ModalButton>
    </VENFTApp_Blazor.Components.Modal.ModalFooter>
</VENFTApp_Blazor.Components.Modal.Modal>

<VENFTApp_Blazor.Components.Modal.Modal @bind-Visible="@removeBookmarkVisible">
    <ModalHeader>
        <ModalTitle>Remove Bookmark</ModalTitle>
    </ModalHeader>
    <ModalBody>
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="col d-flex justify-content-center align-items-center">
                        <span>Do you really want to remove this bookmark?</span>
                    </div>
                </div>
            </div>
        </div>
    </ModalBody>
    <VENFTApp_Blazor.Components.Modal.ModalFooter>
        <ModalButton Kind="ModalButtonKind.Cancel">Cancel</ModalButton>
        <ModalButton OnClick="@RemoveBookmarkConfirm">Ok</ModalButton>
    </VENFTApp_Blazor.Components.Modal.ModalFooter>
</VENFTApp_Blazor.Components.Modal.Modal>

@code {

    [Parameter]
    public bool IsInBookmarks { get; set; }

    [Parameter]
    public EventCallback<VEDriversLite.Bookmarks.Bookmark> BookmarkRefreshed { get; set; }

    private string _address = string.Empty;
    [Parameter]
    public string Address
    {
        get => _address;
        set
        {
            if (!string.IsNullOrEmpty(value))
                _address = value;
        }
    }

    private bool addBookmarkVisible = false;
    private bool removeBookmarkVisible = false;
    private VEDriversLite.Bookmarks.Bookmark newBookmark = new VEDriversLite.Bookmarks.Bookmark();

    private void showAddOrRemoveBookmark()
    {
        if (!IsInBookmarks)
            addBookmarkVisible = true;
        else
            removeBookmarkVisible = true;
    }

    private async Task AddBookmarkConfirm()
    {
        newBookmark.Address = _address;
        await AddBookmark(newBookmark.Name, newBookmark.Address, newBookmark.Note);
        addBookmarkVisible = false;
        StateHasChanged();
    }

    private async Task AddBookmark(string name, string address, string note)
    {
        if (!string.IsNullOrEmpty(name) && !string.IsNullOrEmpty(address))
        {
            if (string.IsNullOrEmpty(note))
                note = string.Empty;

            var bks = await AppData.Account.AddBookmark(name, address, note);
            if (bks.Item1)
                await localStorage.SetItemAsync("bookmarks", bks.Item2);

            BookmarkRefreshed.InvokeAsync(newBookmark);
        }
    }

    private async Task RemoveBookmarkConfirm()
    {
        await RemoveBookmark(_address);
        removeBookmarkVisible = false;
    }

    private async Task RemoveBookmark(string address)
    {
        if (!string.IsNullOrEmpty(address))
        {
            var bks = await AppData.Account.RemoveBookmark(address);
            if (bks.Item1)
                await localStorage.SetItemAsync("bookmarks", bks.Item2);
        }
        newBookmark = new VEDriversLite.Bookmarks.Bookmark() { Address = address };
        BookmarkRefreshed.InvokeAsync(newBookmark);
    }
}
