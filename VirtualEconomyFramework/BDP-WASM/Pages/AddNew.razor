@using VEDriversLite.NFT
@using VEDriversLite.NFT.Imaging.Xray
@using VEBlazor.Components.Minting
@using VEBlazor.Components.NFTs.Imaging.Xray
@inject AppData AppData

@page "/addnew"

<PageTitle>@AppData.AppNick - Add New Data</PageTitle>

<VEBlazor.Components.PageHeader Title="Add New Data" BreadcrumbItems="@(new string[] { AppData.AppNick, "Add New Data" })" />

<VEBlazor.Pages.AddNew @ref="AddnewRef" MintingPageName="default" NFT="@AppData.GetMintingNFTTabNFT()" NFTType="@NFTTypes.XrayImage" Address="@AppData.Account.Address" >
    <SpecificParamsStepHeader>
        Xray
    </SpecificParamsStepHeader>
    <SpecificParamsStepContent>
    @if (AppData.GetMintingNFTTabNFT().Type == NFTTypes.XrayImage)
    {
        <Row>
            <Column>
                <Button Color="Color.Primary" Clicked="() => loadNFTFromTemplate.Show()" Block Margin="Margin.Is2.FromBottom">
                    <Icon Name="IconName.FolderPlus" Margin="Margin.Is3.FromEnd" />
                    Load from template
                </Button>
                <LoadNFTFromTemplate @ref="loadNFTFromTemplate" OnLoadNFTTemplate="@onLoadNFTTemplateHandler" />
            </Column>
        </Row>
      <Row>
            <Column>
                <XrayExposureParamsForm @ref="xrayParamsFormRef"
                                        @bind-Voltage="@((AppData.GetMintingNFTTabNFT() as XrayImageNFT).XrayParams.Voltage)"
                                        @bind-Current="@((AppData.GetMintingNFTTabNFT() as XrayImageNFT).XrayParams.Current)"
                                        @bind-Time="@((AppData.GetMintingNFTTabNFT() as XrayImageNFT).XrayParams.ExposureTime)" />
            </Column>
        </Row>
    }
    </SpecificParamsStepContent>
</VEBlazor.Pages.AddNew>

@code {
    XrayExposureParamsForm? xrayParamsFormRef;
    VEBlazor.Pages.AddNew? AddnewRef;
    LoadNFTFromTemplate? loadNFTFromTemplate;

    async Task onLoadNFTTemplateHandler(INFT nft)
    {
        if (nft != null)
        {
            await AppData.GetMintingNFTTabNFT().Fill(nft);
            if (AddnewRef != null)
                await AddnewRef.RefreshImageInUploadComponent();
            if (xrayParamsFormRef != null)
                xrayParamsFormRef.SetValues((AppData.GetMintingNFTTabNFT() as XrayImageNFT).XrayParams.Voltage,
                                            (AppData.GetMintingNFTTabNFT() as XrayImageNFT).XrayParams.Current,
                                            (AppData.GetMintingNFTTabNFT() as XrayImageNFT).XrayParams.ExposureTime);
            StateHasChanged();
        }
    }
}