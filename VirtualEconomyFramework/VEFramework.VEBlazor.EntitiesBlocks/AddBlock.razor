@inherits EntitiesBlocksComponentBase
@inject AppData AppData

<Modal @ref="AddBlockModal">
    <ModalContent Centered Size="ModalSize.ExtraLarge">
        <ModalHeader>
            <ModalTitle>Add Block</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            @if (Item != null && Item.Id != null)
            {
            <Row>
                <Column>
                    <Field>
                        <FieldLabel>Name</FieldLabel>
                        <TextEdit Placeholder="Block Name" @bind-Text="@Block.Name" />
                    </Field>
                    <Field>
                        <FieldLabel>Description</FieldLabel>
                        <TextEdit Placeholder="Block Description" @bind-Text="@Block.Description" />
                    </Field>
                    <StartEndDaySelector StartTime="@Block.StartTime" 
                                         EndTime="@Block.EndTime" 
                                         StartTimeChanged="@startDateChanged"
                                         EndTimeChanged="@endDateChanged"
                                         StartDayLabel="Start of the Block"
                                         EndDayLabel="End of the Block" />

                    <Check TValue="bool" @Checked="@repetitiveBlock" CheckedChanged="@OnRepetitiveBlockCheckedChanged">Repetitive Block</Check>
                        
                    @if (repetitiveBlock)
                    {
                        <StartEndDaySelector StartTime="@((DateTime)Block.RepetitiveFirstRun)" 
                                         EndTime="@((DateTime)Block.RepetitiveEndRun)" 
                                         StartTimeChanged="@firstRunDateChanged"
                                         EndTimeChanged="@endRunDateChanged"
                                         StartDayLabel="First Run Of repetitive Block"
                                         EndDayLabel="End Run of repetitive Block" />

                            <Check TValue="bool" @bind-Checked="@repetitiveDayBlock">Repetitive Day Block</Check>
                            @if (!repetitiveDayBlock)
                            {
                            <Field>
                                <FieldLabel>Off Time in Hours</FieldLabel>
                                <NumericPicker TValue="int" Min="0" Max="1000" Value="@((int)Block.OffPeriod.Value.TotalHours)" ValueChanged="OnOfftimeValueChanged" Decimals="4" />
                                <FieldHelp>Please fill the off time between repetition</FieldHelp>
                            </Field>
                            }
                            else
                            {
                            <Check TValue="bool" @bind-Checked="@Block.JustInWeek">Just Week Days</Check>
                            <Check TValue="bool" @bind-Checked="@Block.JustInWeekends">Just Weekend</Check>
                            }
                                
                    }
                    <Field>
                        <FieldLabel>Total Amount of Power</FieldLabel>
                        <NumericPicker TValue="double" Min="0" Max="1000" @bind-Value="@Block.Amount" Decimals="4" />
                        <FieldHelp>Please fill the total amount of energy in the block</FieldHelp>
                    </Field>
                    <Field>
                        <RadioGroup TValue="BlockType" Name="types" @bind-CheckedValue="@Block.Type">
                            <Radio Value="@(BlockType.Real)">Real</Radio>
                            <Radio Value="@(BlockType.Simulated)">Simulated</Radio>
                        </RadioGroup>
                    </Field>
                    <Field>
                        <RadioGroup TValue="BlockDirection" Name="direction" @bind-CheckedValue="@Block.Direction">
                            <Radio Value="@(BlockDirection.Created)">Created</Radio>
                            <Radio Value="@(BlockDirection.Consumed)">Consumed</Radio>
                            <Radio Value="@(BlockDirection.Stored)">Stored</Radio>
                        </RadioGroup>
                    </Field>
                </Column>
            </Row>
            <Row>
                <Column>
                    @if (blockChange)
                    {
                    <Button Color="Color.Primary" Outline Clicked="@changeBlock">Change Block</Button>
                    }
                    else
                    {
                    <Button Color="Color.Primary" Outline Clicked="@addBlock">Add Block</Button>
                    }
                </Column>
            </Row>
            }
            else
            {
                <Row>
                    <Column>
                        <Span>Please select the Entity to add new block. Click to entity in the Tree.</Span>
                    </Column>
                </Row>
            }
        </ModalBody>
    </ModalContent>
</Modal>

@if (WithButton)
{
    <Button Color="Color.Primary" Block Outline Clicked="@openAddBlock">New Block</Button>
}

@code {

    [Parameter]
    public bool WithButton { get; set; } = false;

    Modal? AddBlockModal;
    bool basedOnTotalPower = true;
    bool basedOnHourPowerConsumption = false;
    bool repetitiveBlock = false;
    bool repetitiveDayBlock = false;
    bool blockChange = false;

    [Inject] INotificationService NotificationService { get; set; }

    public async Task LoadBlock(IBlock inputblock)
    {
        if (inputblock != null)
            Block.Fill(inputblock);
        if (AddBlockModal != null)
            await AddBlockModal.Show();
        blockChange = true;
        await InvokeAsync(StateHasChanged);
    }

    async Task startDateChanged(DateTime e)
    {
        Block.StartTime = (DateTime)e;
    }

    async Task endDateChanged(DateTime e)
    {
        Block.Timeframe = (DateTime)e - Block.StartTime;
    }

    async Task firstRunDateChanged(DateTime e)
    {
        Block.RepetitiveFirstRun = (DateTime)e;
    }

    async Task endRunDateChanged(DateTime e)
    {
        Block.RepetitiveEndRun = (DateTime)e;
    }

    async Task OnOfftimeValueChanged(int e)
    {
        Block.OffPeriod = new TimeSpan(e,0,0);
    }

    async Task OnRepetitiveBlockCheckedChanged(bool e)
    {
        if (e == null) return;
        repetitiveBlock = e;
        if (e)
        {
            if (Block.RepetitiveFirstRun == null)
                Block.RepetitiveFirstRun = DateTime.Now;
            if (Block.RepetitiveEndRun == null)
                Block.RepetitiveEndRun = DateTime.Now.AddDays(1);
        }
        await InvokeAsync(StateHasChanged);
    }

    async Task openAddBlock()
    {
        if (AddBlockModal != null)
        {
            Block.StartTime = DateTime.Now;
            Block.Timeframe = new TimeSpan(1,0,0);
            Block.RepetitiveFirstRun = DateTime.Now;
            Block.RepetitiveEndRun = DateTime.Now;
            Block.OffPeriod = new TimeSpan(1,0,0);
            blockChange = false;
            await AddBlockModal.Show();
        }
    }

    async Task addBlock()
    {
        if (Block.EndTime < Block.StartTime)
        {
            await NotificationService.Error("Please set end time bigger than start time!", "Cannot Add Block");
            return;
        }
        if (Block.Timeframe.TotalSeconds == 0)
        {
            await NotificationService.Error("Please set end time bigger than start time!", "Cannot Add Block");
            return;
        }
        if (Block.Amount <= 0)
        {
            await NotificationService.Error("Please set amount!", "Cannot Add Block");
            return;
        }

        Block.Id = Guid.NewGuid().ToString();

        if (repetitiveBlock)
        {
            var blocks = BlockHelpers.CreateRepetitiveBlock(Block.RepetitiveFirstRun.Value,
                                                            Block.RepetitiveEndRun.Value,
                                                            Block.StartTime,
                                                            Block.EndTime,
                                                            Block.OffPeriod.Value,
                                                            Block.Amount,
                                                            "",
                                                            Item.Id,
                                                            Block.Direction,
                                                            Block.Type,
                                                            Block.Name);

            AppData.EntitiesHandler.AddBlocksToEntity(Item.Id, blocks);
        }
        else if (!repetitiveBlock && repetitiveDayBlock)
        {
            var blocks = BlockHelpers.CreateRepetitiveDayBlock(Block.RepetitiveFirstRun.Value,
                                                               Block.RepetitiveEndRun.Value,
                                                               Block.StartTime,
                                                               Block.EndTime,
                                                               Block.Amount,
                                                               "",
                                                               Item.Id,
                                                               Block.Direction,
                                                               Block.Type,
                                                               Block.JustInWeek,
                                                               Block.JustInWeekends,
                                                               Block.Name);
            AppData.EntitiesHandler.AddBlocksToEntity(Item.Id, blocks);
        }
        else if (!repetitiveBlock && !repetitiveDayBlock)
        {
            AppData.EntitiesHandler.AddBlockToEntity(Item.Id, Block);
        }
        if (AddBlockModal != null)
            await AddBlockModal.Hide();
        await BlockChanged.InvokeAsync(Block);
    }

    async Task changeBlock()
    {
        if (Block.EndTime < Block.StartTime)
        {
            await NotificationService.Error("Please set end time bigger than start time!", "Cannot Add Block");
            return;
        }
        if (Block.Timeframe.TotalSeconds == 0)
        {
            await NotificationService.Error("Please set end time bigger than start time!", "Cannot Add Block");
            return;
        }
        if (Block.Amount <= 0)
        {
            await NotificationService.Error("Please set amount!", "Cannot Add Block");
            return;
        }

        if (Item != null && Item.Id != null)
        {
            var res = AppData.EntitiesHandler.ChangEntityBlockParameters(Item.Id,
                                                                           Block.Id,
                                                                           Block.Name,
                                                                           Block.Description,
                                                                           Block.Type,
                                                                           Block.Amount,
                                                                           Block.Direction,
                                                                           Block.StartTime,
                                                                           Block.Timeframe);

            if (AddBlockModal != null)
                await AddBlockModal.Hide();
            await BlockChanged.InvokeAsync(Block);
        }
    }
}
