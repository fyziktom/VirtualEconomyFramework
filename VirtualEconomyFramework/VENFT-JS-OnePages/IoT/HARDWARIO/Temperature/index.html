<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>HARDWARIO IoT - Temperature</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <div class="container-fluid">
                    <div class="row d-sm-flex justify-content-between align-items-center justify-content-xl-center" style="margin-top: 20px;">
						<div class="col d-flex d-sm-flex justify-content-center align-items-center justify-content-xl-center">
							<h3 class="text-dark">HARDWARIO IoT NFT Messages - Temperature</h3>
						</div>
					</div>

					<div class="row d-flex " style="margin-top:20px;">
                        
                        <div  class="col">
                            <table id="temperatures">
                                <thead>
                                    <tr>
                                        <th style="min-width:150px;width:150px;">Name</th>
                                        <th style="min-width:150px;width:150px;">Date and Time</th>
                                        <th style="min-width:120px;width:120px;">Temperature °C</th>
                                        <th style="min-width:120px;width:120px;">Position</th>
                                        <th style="min-width:120px;width:120px;">Link To NFT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!--This is where the data will be drawn-->
                                </tbody>
                                    
                            </table>
                        </div>
                        <!--This is the div where the plot will be drawn-->
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    <div id="temperaturePlot" style="width:100%;max-width:700px"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <!--you can display map, another graph...etc.-->
                                </div>
                            </div>
                        </div>
					</div>

                    <div class="row d-xl-flex align-items-xl-center" style="margin-top: 20px;min-height: 300px;">
                        
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span><a href="https://veframework.com/" targe="blank">Copyright © VEFramework 2022</a></span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
 
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.js"></script>
    <script src="assets/js/plotly-latest.min.js"></script>
    <script src="assets/js/helpers.js"></script>
    <script src="assets/js/graph.js"></script>

    <script>
    var start = 0;
    var records = 25;
    var lastnumberofdisplayedrecords = 0;

    // only these tokens are loaded when you load it from the Neblio API
    var tokenid = 'La58e9EeXUMx41uyfqk6kgVWAQq9yBs44nuQW8';

    //when you will set this it will try to obtain data from the VENFT App Server API
    var getNFTdataFromVENFTAPI = false; 
    
	$(document).ready(function () {
        // when you add the txid url parameter it will display just one NFT
        if (window.location.href.indexOf("txid") > -1) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var txid = urlParams.get('txid');
            
            if (getNFTdataFromVENFTAPI) {
                addOneNFT(u.txid);
            }
            else {
                getNFTMetadata(u.txid);
            }
        }

        // TODO: start of the first record to display
        if (window.location.href.indexOf("start") > -1) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var starts = urlParams.get('start');
            start = parseInt(starts);
        }
        // TODO: number of the records to display
        if (window.location.href.indexOf("records") > -1) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var recordss = urlParams.get('records');
            records = parseInt(recordss);
        }

       // when you will add the address as the url parameter 
       // it will display all available NFT IoT Messages
       if (window.location.href.indexOf("address") > -1) {
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			var address = urlParams.get('address');
			if (address != undefined && address != null && address != '') {
                getAllNFTTxIds(address);
                setInterval(() => {
                    getAllNFTTxIds(address);
                }, 30000);

                setInterval(() => {
                    // refresh just when there is new line in the table
                    var actualdisplayed = nftiotmessages.length;
                    if (lastnumberofdisplayedrecords != actualdisplayed) {
                        lastnumberofdisplayedrecords = actualdisplayed;
                        sortTable('temperatures');
                        loadDataToTheChart();
                    }
                }, 2500);
			}
	    }

	});

    // this function will add new message to the table with the data
    var nftiotmessages = [];
    function addHWIOTemperatureTableLine(data) {
        try {
            //console.log(data);
            var dataparsed = JSON.parse(data.description); //parse data included in descriptoin of the IoTMessage NFT
            //console.log(dataparsed);
            
            if (($("#temperature-" + data.utxo).length == 0) ) {
                $('#temperatures').children('tbody').append(
                    '<tr id="temperature-' + data.utxo + '" style="min-width:800px;width:800px;">' + 
                        '<td style="min-width:200px;width:250px;">' + dataparsed.name + '</td>' +
                        '<td style="min-width:200px;width:250px;">' + dataparsed.created_at + '</td>' + 
                        '<td style="min-width:100px;width:100px;">' + dataparsed.data.sensor.thermometer.temperature + '</td>' +
                        '<td style="min-width:80px;width:80px;"><a href="http://www.google.com/maps/place/' + dataparsed.data.tracking.latitude + ',' + dataparsed.data.tracking.longitude + '" target="_blank">Map</a></td>' +
                        '<td style="min-width:80px;width:80px;"><a href="https://explorer.nebl.io/tx/' + data.utxo + '" target="_blank">Explorer</a></td>' +
                    '</tr>');

                nftiotmessages.push(data);
            }
        }
        catch {}
    }

    // this function will obtain the data from the VENFT Api.
    // It is easier than read it from Neblio API, but it can be done too...se below
    function addOneNFT(txid) {
        if (txid != undefined && txid != null && txid != '') {

            var url = 'https://venftappserver.azurewebsites.net/api/GetNFT/' + txid;
            var thisClass = this;
            $.ajax(url,
            {
                contentType: 'application/json;charset=utf-8',
                method: 'GET',
                dataType: 'json',   // type of response data
                timeout: 10000,     // timeout milliseconds
                success: function (data, status, xhr) {   // success callback function
                    if (data != null && data.typeText == 'NFT IoTMessage'){
                        addHWIOTemperatureTableLine(data);
                    }
                },
                error: function (jqXhr, textStatus, errorMessage) { // error callback 
                    console.log('Error: "' + errorMessage + '"');
                }
            });
        }
    }

    // Get metadata of the transaction from the Neblio API
    function getNFTMetadata(txid) {
        if (txid != '' || txid != ' ') {

            var url = 'https://ntp1node.nebl.io/ntp1/tokenmetadata/' + tokenid + '/' + txid;
            $.ajax(url,
            {
                contentType: 'application/json;charset=utf-8',
                method: 'GET',
                dataType: 'json',   // type of response data
                timeout: 10000,     // timeout milliseconds
                success: function (data, status, xhr) {   // success callback function
                    //console.log(data);
                    if (data != null){
                        try 
                        {
                            if (data.metadataOfUtxo.userData.meta != undefined) {
                                if (data.metadataOfUtxo.userData.meta.length == 0) {
                                    return;
                                }

                                var isNFT = false;
                                // check if it is NFT
                                for( var m in data.metadataOfUtxo.userData.meta) {
                                    var nft = data.metadataOfUtxo.userData.meta[m]['NFT'];
                                    if (nft != undefined){
                                        //console.log('NFT!!!');
                                        isNFT = true;
                                    }
                                }
                                if (!isNFT) {
                                    return;
                                }

                                var firsttx = false;
                                // check if it is NFT init tx
                                for( var m in data.metadataOfUtxo.userData.meta) {
                                    var nftfirst = data.metadataOfUtxo.userData.meta[m]['NFT FirstTx'];
                                    if (nftfirst != undefined){
                                        firsttx = true;
                                    }
                                }
                                if (!firsttx) {
                                    return;
                                }
                                // This is first NFT tx so we can load all info from it

                                //create the nft data carrier
                                var nft = {
                                    'name':'',
                                    'author':'',
                                    'description':'',
                                    'imagelink':'',
                                    'type':'',
                                    'utxo':txid,
                                };
                                // iterate through the metadata and save the correct data to the object
                                for( var m in data.metadataOfUtxo.userData.meta) {
                                    
                                    var name = data.metadataOfUtxo.userData.meta[m]['Name'];
                                    if (name != undefined){
                                        nft['name'] = name;
                                    }
                                    var aut = data.metadataOfUtxo.userData.meta[m]['Author'];
                                    if (aut != undefined){
                                        nft['author'] = aut;
                                    }
                                    var img = data.metadataOfUtxo.userData.meta[m]['Image'];
                                    if (img != undefined){
                                        nft['image'] = img;
                                    }
                                    var desc = data.metadataOfUtxo.userData.meta[m]['Description'];
                                    if (desc != undefined){
                                        nft['description'] = desc;
                                    }

                                    var type = data.metadataOfUtxo.userData.meta[m]['Type'];
                                    if (type != undefined){
                                        nft['type'] = type;
                                    }
                                }

                                if (nft['type'] == 'NFT IoTMessage') {
                                    addHWIOTemperatureTableLine(nft);
                                }
                            }
                        }
                        catch {}
                    }
                },
                error: function (jqXhr, textStatus, errorMessage) { // error callback 
                    console.log('Error: "' + errorMessage + '"');
                }
            });
        }
    }

    // Display just NFTs - the utxos which has value 10000 satoshi (Neblio) 
    // and it has just one token in amount of the tokens
    function displayNFTs(utxos) {
        var maxdisplay = 60;
        var displayed = 0;
        for (var ui in utxos) {
            if (displayed < maxdisplay) {
                var u = utxos[ui];
                if (u.value != undefined && u.value != null && u.value == 10000) {
                    if (u.tokens != undefined && 
                        u.tokens[0] != undefined && 
                        u.tokens[0] != null && 
                        u.tokens[0].amount != undefined && 
                        u.tokens[0].amount == 1) {
                        
                        // if the utxo aleready has some line in table do not need to load it
                        // this will save a lots of requests
                        if (($("#temperature-" + u.txid).length == 0) ) {
                            if (getNFTdataFromVENFTAPI) {
                                addOneNFT(u.txid);
                            }
                            else {
                                getNFTMetadata(u.txid);
                            }
                        }
                    }
                }
                displayed++;
            }
        }
    }

    // this function will load all the utxos on the address
    // it uses Neblio API
    var utxos = {};
    function getAllNFTTxIds(address) {

        if (address != '' || address != ' ') {
            var url = 'https://ntp1node.nebl.io/ntp1/addressinfo/' + address;
            var thisClass = this;
            $.ajax(url,
            {
                contentType: 'application/json;charset=utf-8',
                method: 'GET',
                dataType: 'json',   // type of response data
                timeout: 10000,     // timeout milliseconds
                success: function (data, status, xhr) {   // success callback function
                    //console.log(data);
                    if (data != null){
                        try {
                            if (data.utxos != undefined && data.utxos != null) {
                                utxos = data.utxos;
                                displayNFTs(data.utxos);
                            }
                        }
                        catch {}
                    }
                },
                error: function (jqXhr, textStatus, errorMessage) { // error callback 
                    console.log('Error: "' + errorMessage + '"');
                }
            });
        }
    }
    </script>
</body>

</html>